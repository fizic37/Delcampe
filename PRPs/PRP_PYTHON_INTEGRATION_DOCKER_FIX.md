# PRP: Fix Python Integration in Docker for Image Cropping

**Date**: 2025-11-05
**Status**: ACTIVE - Critical Production Issue
**Priority**: CRITICAL
**Complexity**: HIGH
**Related**: tech_stack_and_architecture.md, critical_constraints_preservation.md

## Executive Summary

Python-based image cropping functionality works locally but fails silently in Docker production deployment. Root cause: `reticulate` R package doesn't know which Python interpreter to use in the container, likely defaulting to system Python which lacks OpenCV/numpy dependencies.

## Problem Statement

### Symptom
- **Local (Windows)**: Image cropping works perfectly
  - Grid detection succeeds (3x1, 1x1 grids)
  - Individual cards extracted successfully
  - Face+verso combination creates lot images
- **Production (Docker)**: Image cropping silently fails
  - No cropped images generated
  - No Python import messages in logs
  - Application otherwise functional (login, eBay, database all work)

### Evidence from Logs

**Expected startup logs** (from local):
```
‚ú® Importing Python module...
‚úÖ Python imported: detect_grid_layout, crop_image_with_boundaries
```

**Actual production logs**:
```
‚úÖ Database initialized
Listening on http://127.0.0.1:41161
‚úÖ Session started
```

**Missing**: ANY mention of Python initialization

## Root Cause Analysis

### Python Integration Architecture

**Local Environment (Windows)**:
```
venv_proj/Scripts/python.exe  ‚Üê Windows Python executable
  ‚îú‚îÄ‚îÄ cv2 (OpenCV) ‚úÖ installed
  ‚îú‚îÄ‚îÄ numpy ‚úÖ installed
  ‚îî‚îÄ‚îÄ extract_postcards.py ‚úÖ loads successfully
```

**Docker Environment (Linux)**:
```
/srv/shiny-server/delcampe/venv_proj/bin/python  ‚Üê Linux Python executable
  ‚îú‚îÄ‚îÄ cv2 (OpenCV) ‚úÖ installed (verified during build)
  ‚îú‚îÄ‚îÄ numpy ‚úÖ installed (verified during build)
  ‚îî‚îÄ‚îÄ extract_postcards.py ‚úÖ exists at inst/python/
```

**System Python** (Docker):
```
/usr/bin/python3  ‚Üê System Python (comes with base image)
  ‚îú‚îÄ‚îÄ cv2 ‚ùå NOT installed
  ‚îî‚îÄ‚îÄ numpy ‚ùå NOT installed
```

### How Reticulate Chooses Python

**Priority order** (from reticulate documentation):
1. `RETICULATE_PYTHON` environment variable ‚Üê **MISSING in Docker**
2. Python specified in `.Renviron` ‚Üê **Doesn't include RETICULATE_PYTHON**
3. Active virtual environment
4. System Python (`/usr/bin/python3`) ‚Üê **Probably being used**

**Current Docker .Renviron** (generated by startup script):
```bash
EBAY_ENVIRONMENT=production
EBAY_PROD_CLIENT_ID=...
EBAY_PROD_CLIENT_SECRET=...
# ... more eBay vars
# ‚ùå MISSING: RETICULATE_PYTHON=/srv/shiny-server/delcampe/venv_proj/bin/python
```

### Why It Fails Silently

**Code flow** (R/app_server.R:64-112):
```r
if (!exists(".postal_card_py_module", envir = .GlobalEnv)) {
  cat("\n‚ú® Importing Python module...\n")
  # ...
  tryCatch({
    py_module <- reticulate::import_from_path(...)
    cat("‚úÖ Python imported...\n\n")
  }, error = function(e) {
    cat("‚ùå Import failed:", e$message, "\n\n")
    assign(".postal_card_python_loaded", FALSE, envir = .GlobalEnv)
  })
}
```

**Hypothesis**:
- `reticulate::import_from_path()` succeeds (no error thrown)
- But uses system Python without cv2/numpy
- When cropping is attempted, Python import errors occur silently
- User sees no cropped images, no error messages

## Historical Context

### Original Integration (Working Locally)

**From critical_constraints_preservation.md**:
```r
# Original pattern that MUST be preserved:
reticulate::source_python("inst/python/extract_postcards.py")
py_results <- tryCatch({
  detect_grid_layout(rv$image_path_original)
}, error = function(e) {
  warning(paste("Python detect_grid_layout error:", e$message))
  NULL
})
```

**Key points**:
- Uses `source_python()` originally
- Now uses `import_from_path()` (proper reticulate pattern)
- Virtual environment: `venv_proj/` with Python 3.12.9
- Dependencies: cv2, numpy, os

### Docker Build Process

**From Dockerfile:48-51**:
```dockerfile
# Setup Python virtual environment
RUN python3 -m venv venv_proj \
    && ./venv_proj/bin/pip install --upgrade pip \
    && ./venv_proj/bin/pip install opencv-python numpy
```

**Verification** (from user testing):
```bash
docker exec delcampe-app ls -la /srv/shiny-server/delcampe/venv_proj/bin/python
# Output: lrwxrwxrwx ... python -> python3 ‚úÖ EXISTS

docker exec delcampe-app find /srv/shiny-server/delcampe -name "extract_postcards.py"
# Output: /srv/shiny-server/delcampe/inst/python/extract_postcards.py ‚úÖ EXISTS
```

**Conclusion**: All pieces exist, but reticulate can't find them.

## Solution Design

### Phase 1: Add RETICULATE_PYTHON to .Renviron

**Modify Dockerfile startup script** to include Python path:

**Location**: Dockerfile:74-94

**Current**:
```dockerfile
RUN echo 'cat > /srv/shiny-server/delcampe/.Renviron <<EOF' >> /usr/local/bin/start-shiny.sh \
    && echo 'EBAY_ENVIRONMENT=${EBAY_ENVIRONMENT}' >> /usr/local/bin/start-shiny.sh \
    # ... more EBAY vars ...
    && echo 'EOF' >> /usr/local/bin/start-shiny.sh \
```

**Add** (after EBAY vars, before EOF):
```dockerfile
&& echo 'RETICULATE_PYTHON=/srv/shiny-server/delcampe/venv_proj/bin/python' >> /usr/local/bin/start-shiny.sh \
```

**Why this works**:
- `.Renviron` loaded before R session starts
- Reticulate checks `RETICULATE_PYTHON` environment variable first
- Ensures correct Python interpreter with cv2/numpy

### Phase 2: Add Explicit Python Configuration in app_server.R

**Alternative/backup approach** if Phase 1 insufficient:

**Location**: R/app_server.R:64 (before import_from_path)

**Add**:
```r
# CRITICAL: Ensure reticulate uses venv_proj Python
if (file.exists("/data")) {
  # Docker environment
  Sys.setenv(RETICULATE_PYTHON = "/srv/shiny-server/delcampe/venv_proj/bin/python")
  cat("üêç Configured Python:", Sys.getenv("RETICULATE_PYTHON"), "\n")
} else {
  # Local development (Windows)
  venv_python <- file.path(getwd(), "venv_proj", "Scripts", "python.exe")
  if (file.exists(venv_python)) {
    Sys.setenv(RETICULATE_PYTHON = venv_python)
    cat("üêç Configured Python:", Sys.getenv("RETICULATE_PYTHON"), "\n")
  }
}
```

**Benefits**:
- Environment-aware (Docker vs local)
- Explicit logging for debugging
- Sets reticulate Python before import

### Phase 3: Add Diagnostic Logging

**Add after Python import** (R/app_server.R:~112):

```r
# Diagnostic logging
cat("\nüìã Python Configuration:\n")
cat("  RETICULATE_PYTHON:", Sys.getenv("RETICULATE_PYTHON"), "\n")
cat("  Python version:", reticulate::py_config()$version, "\n")
cat("  Python executable:", reticulate::py_config()$python, "\n")
cat("  Virtual env:", reticulate::py_config()$virtualenv, "\n")
cat("  OpenCV available:", reticulate::py_module_available("cv2"), "\n")
cat("  NumPy available:", reticulate::py_module_available("numpy"), "\n\n")
```

**Purpose**:
- Verify correct Python is loaded
- Confirm cv2/numpy availability
- Aid debugging if issues persist

## Implementation Plan

### Step 1: Modify Dockerfile (Minimal Change)

**File**: `Dockerfile`

**Change**: Add one line to .Renviron generation (line ~89):

```dockerfile
&& echo 'RETICULATE_PYTHON=/srv/shiny-server/delcampe/venv_proj/bin/python' >> /usr/local/bin/start-shiny.sh \
```

**Test locally**:
```bash
# Rebuild Docker image
docker build -t delcampe-app:latest .

# Check .Renviron includes RETICULATE_PYTHON
docker run --rm delcampe-app cat /srv/shiny-server/delcampe/.Renviron | grep RETICULATE
```

### Step 2: Add Diagnostic Logging (app_server.R)

**File**: `R/app_server.R`

**Location**: After line 112 (after Python import block)

**Add**: Diagnostic logging block (see Phase 3 above)

**Test locally**:
```r
devtools::load_all()
golem::run_dev()

# Check console output shows:
# üêç Configured Python: .../venv_proj/Scripts/python.exe
# üìã Python Configuration:
#   OpenCV available: TRUE
#   NumPy available: TRUE
```

### Step 3: Commit and Deploy

```bash
# Commit changes
git add Dockerfile R/app_server.R
git commit -m "fix: Configure reticulate to use venv_proj Python in Docker

- Add RETICULATE_PYTHON to .Renviron generation
- Add diagnostic logging for Python configuration
- Ensures OpenCV/numpy available for image cropping
- Fixes silent failure of crop functionality in production"

# Push to GitHub
git push origin main

# Deploy to Hetzner
ssh root@37.27.80.87
cd /root/Delcampe
git pull origin main
docker build -t delcampe-app:latest .
docker-compose down && docker-compose up -d
```

### Step 4: Verify in Production

**Check logs for Python configuration**:
```bash
docker-compose logs -f | grep -A 10 "Python"

# Should see:
# ‚ú® Importing Python module...
# üêç Configured Python: /srv/shiny-server/delcampe/venv_proj/bin/python
# ‚úÖ Python imported: detect_grid_layout, crop_image_with_boundaries
# üìã Python Configuration:
#   OpenCV available: TRUE
#   NumPy available: TRUE
```

**Test cropping functionality**:
1. Visit `https://your-tunnel-url.trycloudflare.com`
2. Login as master1@delcampe.com
3. Upload a postal card grid image
4. Click "Detect Grid" - should see grid lines
5. Click "Extract Cards" - should see individual cropped images
6. Verify cropped images display correctly

## Acceptance Criteria

### Must Have
1. ‚úÖ Dockerfile generates .Renviron with `RETICULATE_PYTHON` set
2. ‚úÖ App startup logs show Python configuration
3. ‚úÖ Logs confirm `OpenCV available: TRUE`
4. ‚úÖ Logs confirm `NumPy available: TRUE`
5. ‚úÖ Grid detection works (detects correct rows/columns)
6. ‚úÖ Image cropping works (generates individual card images)
7. ‚úÖ Cropped images display in UI
8. ‚úÖ Face+verso combination creates lot images

### Should Have
1. Diagnostic logs aid future debugging
2. Solution works for both postal cards and stamps
3. No performance degradation
4. Error messages if Python dependencies missing

### Nice to Have
1. Automated test for Python integration
2. Health check endpoint includes Python status
3. Admin panel shows Python configuration

## Risk Assessment

**LOW RISK**: Minimal code changes
- Only adding environment variable
- Adding logging (no functional changes)
- Not modifying existing Python integration pattern

**HIGH IMPACT**: Enables core functionality
- Image cropping is primary app feature
- Affects both postal cards and stamps workflows
- Critical for user satisfaction

## Rollback Plan

If solution fails:

1. **Revert Dockerfile**:
```bash
git revert HEAD
docker build -t delcampe-app:latest .
docker-compose down && docker-compose up -d
```

2. **Alternative: Use reticulate::use_virtualenv()**:
```r
# In app_server.R, before import:
reticulate::use_virtualenv("/srv/shiny-server/delcampe/venv_proj", required = TRUE)
```

3. **Nuclear option: Reinstall cv2/numpy in system Python**:
```dockerfile
# Add to Dockerfile before app copy:
RUN pip3 install opencv-python numpy
```

## Testing Checklist

### Local Testing (Before Deployment)
- [ ] Dockerfile builds successfully
- [ ] .Renviron includes RETICULATE_PYTHON
- [ ] Diagnostic logs appear in console
- [ ] Test images (test_face.jpg, test_verso.jpg) process correctly
- [ ] Grid detection: 3x1 and 1x1 grids detected
- [ ] Extraction: 3 cards extracted from face image
- [ ] Combination: 1 lot + 3 combined images created

### Production Testing (After Deployment)
- [ ] Container starts without errors
- [ ] Logs show Python configuration messages
- [ ] OpenCV and NumPy marked as available
- [ ] Upload test image through UI
- [ ] Grid detection displays lines correctly
- [ ] Extraction creates cropped images
- [ ] Cropped images visible in UI grid
- [ ] No errors in application logs

## Related Files

### Code Files to Modify
- `Dockerfile` - Add RETICULATE_PYTHON to .Renviron generation
- `R/app_server.R` - Add diagnostic logging (optional but recommended)

### Files to Review (Do NOT Modify)
- `inst/python/extract_postcards.py` - Python image processing (working)
- `R/mod_postal_card_processor.R` - Uses Python functions (working)
- `R/mod_stamp_face_processor.R` - Uses Python functions (working)
- `R/mod_stamp_verso_processor.R` - Uses Python functions (working)

### Reference Documentation
- `.serena/memories/tech_stack_and_architecture.md` - Python integration details
- `.serena/memories/critical_constraints_preservation.md` - Integration patterns
- `docs/DEPLOYMENT_WORKFLOW.md` - Deployment process

## Success Metrics

- **Functionality**: 100% of cropping operations succeed
- **Performance**: Complete workflow in <30 seconds (baseline)
- **Reliability**: No silent failures, clear error messages if issues
- **Maintainability**: Diagnostic logs aid future debugging

## Notes

- This issue highlights importance of environment variable management in Docker
- Reticulate's automatic Python discovery doesn't work well in containers
- Explicit configuration via RETICULATE_PYTHON is best practice for Docker deployments
- Diagnostic logging is critical for debugging R-Python integration issues

## Future Improvements

1. **Automated Testing**: Add integration test that verifies Python cropping works
2. **Health Check**: Include Python/OpenCV status in container health check
3. **Environment Detection**: Consider using `golem::get_golem_options()` for environment config
4. **Documentation**: Add Python troubleshooting section to deployment guide
